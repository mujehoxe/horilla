{% load static i18n generic_template_filters %}

<div id="{{ view_id|safe }}" class="hlv-container">
    <div id="{{ view_id|safe }}" class="hlv-container">
        <div
            class="oh-modal"
            id="bulkUpdateModal{{view_id|safe}}"
            role="dialog"
            aria-labelledby="bulkUpdateModal{{view_id|safe}}"
            aria-hidden="true"
        >
            <div
                class="oh-modal__dialog"
                id="bulkUpdateModalBody{{view_id|safe}}"
            ></div>
        </div>
        {% include "generic/export_fields_modal.html" %}
        <script>
            if (!$(".HTV").length) {
                reloadMessage(null);
            }
        </script>
        <button
            class="reload-record"
            id="{{view_id|safe}}Reload"
            hidden
            hx-get="{{request.path}}?{{saved_filters.urlencode}}"
            hx-target="#{{view_id|safe}}"
            hx-swap="outerHTML"
            hx-on:click="htmxLoadIndicator(this);"
        ></button>
        {% if show_filter_tags %} {% include "generic/filter_tags.html" %} {% endif %}

        {% if queryset|length %}
            {% if bulk_select_option %} {% include "generic/quick_actions.html" %} {% endif %}
            {% comment %}
            {% if show_toggle_form %}
            <div class="oh-sticky-dropdown--header" style="z-index: 13;">
            <div class="oh-dropdown" x-data="{ open: false }">
                <button class="oh-sticky-dropdown_btn" @click="open = !open">
                <ion-icon
                    name="ellipsis-vertical-sharp"
                    role="img"
                    class="md hydrated"
                    aria-label="ellipsis vertical sharp"
                ></ion-icon>
                </button>
                <div
                class="oh-dropdown__menu oh-sticky-table_dropdown"
                x-show="open"
                @click.outside="
                    open = false
                    $($el).closest('.oh-table_sticky--wrapper').parent().find('.reload-record').click();
                "
                >
                {{ toggle_form.as_list }}
                </div>
            </div>
            </div>
            {% endif %} {% endcomment %}

            <div class="bg-white p-5 pe-2 pt-3 rounded-md shadow-card">
                <div
                    class="h-[calc(100vh_-_240px)] overflow-hidden overflow-y-auto overflow-x-auto"
                >
                    <table class="w-full">
                        <thead class="sticky top-0 bg-[white]" style="z-index: 1;">
                            <tr class="border-b border-[#ececec]">
                                {% if bulk_select_option %}
                                    <th
                                        class="text-sm font-medium text-left p-3 w-30"
                                    >
                                        <input
                                            type="checkbox"
                                            value=""
                                            class="w-4 h-4 bg-[#E9EDF7] rounded-sm text-[#e54f38] cursor-pointer"
                                        />
                                    </th>
                                {% endif %}

                                {% for cell in columns %}
                                    {% with cell_attr=header_attrs|get_item:cell.1 %}
                                    <th
                                        class="text-sm font-medium text-left p-3"
                                        id="{{view_id}}-{{ forloop.counter }}-{{cell.1}}-header"

                                    >
                                        <div class="flex gap-3"
                                            style="min-width:150px;"
                                            {{cell_attr|safe}}
                                            {% for sort_map in sortby_mapping %}
                                                {% if sort_map.0 == cell.0 %}
                                                    hx-get="{{search_url}}?{{saved_filters.urlencode}}&{{sortby_key}}={{sort_map.1}}&filter_applied=on"
                                                    hx-target="#{{view_id}}"
                                                {% endif %}
                                            {% endfor %}
                                        >

                                            {% for sort_map in sortby_mapping %}
                                                {% if sort_map.0 == cell.0 %}
                                                    <span
                                                        class="text-xs flex items-center text-primary-600"
                                                    >
                                                        {% if request.sort_order == "asc" and request.sort_key == sort_map.1 %}
                                                            <i class="fa-solid fa-arrow-down"></i>
                                                        {% elif request.sort_order == "desc" and request.sort_key == sort_map.1 %}
                                                            <i class="fa-solid fa-arrow-up"></i>
                                                        {% else %}
                                                            <i class="fa-solid fa-arrow-up"></i>
                                                            <i class="fa-solid fa-arrow-down"></i>
                                                        {% endif %}
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                            <span class="flex w-max"> {{cell.0|safe}} </span>
                                        </div>
                                    </th>
                                    {% endwith %}
                                {% endfor %}
                                {% if options or option_method%}
                                    <th class="text-sm font-medium p-3" {{header_attrs.option|safe}}>
                                        {% trans "Options" %}
                                    </th>
                                {% endif %}
                                {% if actions or action_method %}
                                    <th class="text-sm font-medium p-3" class="lastTh" {{header_attrs.action|safe}}>
                                        {% trans "Actions" %}
                                    </th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for instance in queryset %}
                                <tr class="border-b border-[#f3f3f3]"
                                    data-instance-id="{{instance.id}}"
                                    {{row_attrs|format:instance|safe}}
                                >
                                    {% if bulk_select_option %}
                                    <td class="text-sm text-left p-3 text-[#666]">
                                        <input
                                            type="checkbox"
                                            class="w-4 h-4 bg-[#E9EDF7] rounded-sm text-[#e54f38] cursor-pointer"
                                            data-view-id="{{view_id|safe}}"
                                            title="{% trans "Select Row" %}"
                                            value = "{{instance.pk}}"
                                            onclick="
                                                event.stopPropagation();
                                            "
                                            onchange="
                                                element = $(this)
                                                highlightRow(element);
                                                $(document).ready(function () {
                                                    if (!element.is(':checked')) {
                                                    removeId(element)
                                                    }
                                                    reloadSelectedCount($('#count_{{view_id|safe}}'),'{{selected_instances_key_id}}');
                                                    reloadSelectedCount($('.count_{{view_id|safe}}'),'{{selected_instances_key_id}}');
                                                });
                                            "
                                        />
                                    </td>
                                    {% endif %}
                                    {% for cell in columns %}
                                        {% with attribute=cell.1 index=forloop.counter %}
                                            <td class="text-sm text-left p-3 text-[#666]">
                                                {% if not cell.2 %}
                                                    {{instance|getattribute:attribute|selected_format:request.user.employee_get.employee_work_info.company_id|safe}}
                                                {% else %}
                                                    <div class="oh-profile oh-profile--md">
                                                        <div class="oh-profile__avatar mr-1">
                                                            <img
                                                                src="{{instance|getattribute:cell.2}}"
                                                                alt=""
                                                                class="oh-profile__image oh-table-img"
                                                                width="30"
                                                            />
                                                        </div>
                                                        <span>{{instance|getattribute:attribute|safe}}</span>
                                                    </div>
                                                {% endif %}
                                            </td>
                                        {% endwith %}
                                    {% endfor %}

                                    {% if options or option_method %}
                                        <td class="text-sm text-center p-3 text-[#666]"
                                            onclick="event.stopPropagation()"
                                        >
                                            {% if not option_method %}
                                                <div class="flex justify-center gap-1">
                                                    {% for option in options %}
                                                        {% if option.accessibility|accessibility:instance %}
                                                            <a
                                                                href="#"
                                                                title="{{option.option|safe}}"
                                                                {{option.attrs|format:instance|safe}}
                                                            >
                                                                <ion-icon name="{{option.icon}}"></ion-icon>
                                                            </a>
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% comment %} <button
                                                        class="cursor-pointer px-2 py-1 text-xs bg-[#07bd072e] text-[#00c700] rounded-sm w-6 h-6 flex items-center justify-center ">
                                                        <i class="fa-solid fa-check"></i>
                                                    </button>
                                                    <button
                                                        class="cursor-pointer px-2 py-1 text-xs bg-[#ff000024] text-[red] rounded-sm w-6 h-6 flex items-center justify-center ">
                                                        <i class="fa-solid fa-xmark"></i>
                                                    </button> {% endcomment %}
                                                </div>
                                            {% else %}
                                                {{instance|getattribute:option_method|safe}}
                                            {% endif %}

                                        </td>
                                    {% endif %}

                                    {% if actions or action_method %}
                                        <td class="text-sm text-center p-3 text-[#666]"
                                            onclick="event.stopPropagation()"
                                        >
                                            {% if not action_method %}
                                                <div class="flex justify-center gap-1">
                                                    {% for action in actions %}
                                                        {% if action.accessibility|accessibility:instance %}
                                                            <a
                                                                href="#"
                                                                title="{{action.action|safe}}"
                                                                {{action.attrs|format:instance|safe}}
                                                            >
                                                                <ion-icon name="{{action.icon}}"></ion-icon>
                                                            </a>
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% comment %} <button
                                                        class="cursor-pointer px-2 py-1 text-xs bg-[#07bd072e] text-[#00c700] rounded-sm w-6 h-6 flex items-center justify-center ">
                                                        <i class="fa-solid fa-check"></i>
                                                    </button>
                                                    <button
                                                        class="cursor-pointer px-2 py-1 text-xs bg-[#ff000024] text-[red] rounded-sm w-6 h-6 flex items-center justify-center ">
                                                        <i class="fa-solid fa-xmark"></i>
                                                    </button> {% endcomment %}
                                                </div>
                                            {% else %}
                                                {{instance|getattribute:action_method|safe}}
                                            {% endif %}

                                        </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}
    </div>
</div>
