{% extends "index.html" %}
{% block content %}
{% load static %}
{% load i18n %}

<div class="oh-wrapper mt-3">

    <div class="d-flex mt-3 mb-3" style='justify-content: space-between;
        align-items: center;'>
        <h1 class="oh-main__titlebar-title fw-bold">
          {% trans "Leave Reports" %}
        </h1>

        <!-- Export Button -->
        <button id="export-btn" class="oh-btn oh-btn--secondary" style="margin-top: 10px;">
            <ion-icon name="download-outline" class="mr-1 md hydrated" role="img" aria-label="download"></ion-icon>
            {% trans "Export Table" %}
        </button>
    </div>

    <!-- Model Selection Dropdown -->
    <span class="ms-1 fw-bold" style="font-size:16px;">Choose Model : </span>
    <select id="model-select" class="oh-select oh-select--sm ml-2 mb-2" style="width: 200px;">
        <option value="leave_request">Leave Request</option>
        <option value="available_leave">Available Leave</option>
    </select>

    <!-- Pivot Container -->
    <div id="pivot-container" class="mb-5" style="width: 100%; overflow-x: auto;"></div>
</div>


<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

<!-- jQuery UI -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>

<!-- PivotTable.js CSS and JS -->
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.css" />
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"></script>


<!-- Correct SheetJS (XLSX) Link -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


<!-- Latest stable version of Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

<!-- PivotTable Plotly Renderers -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/plotly_renderers.min.js"></script>


<script>
   {% comment %} $(function () {
         $.getJSON("leave-pivot", function (data) {
            // Add Plotly renderers correctly
            let plotlyRenderers = $.pivotUtilities.plotly_renderers;
    
            // Initialize pivot table with Plotly enabled
            $("#pivot-container").pivotUI(data, {
                rows: ["Name", "Leave Type"],
                cols: [],
                aggregatorName: "Count",
                rendererName: "Table", // Default view as Table
                onRefresh: function (config) {
                    let currentRenderer = config.rendererName;
                    if (currentRenderer === "Table" || currentRenderer === "Table Barchart" || 
                        currentRenderer === "Heatmap" || currentRenderer === "Row Heatmap" || currentRenderer === "Col Heatmap" ) {
                        $("#export-btn").show(); // Show button for tables
                    } else {
                        $("#export-btn").hide(); // Hide button for charts
                    }
                },
                renderers: $.extend(
                    $.pivotUtilities.renderers,
                    plotlyRenderers // Adding Plotly renderers
                )
            });
    
            // Export to Excel on button click
            $("#export-btn").on("click", function () {
                exportTableToExcel("pivot-container", "pivot_report.xlsx");
            });
    
            // Function to export table to Excel with styles
            function exportTableToExcel(containerId, filename) {
                let table = document.querySelector(`#${containerId} .pvtTable`);
                let wb = XLSX.utils.table_to_book(table, { sheet: "Pivot Data" });
    
                // Apply custom styles for Excel
                let ws = wb.Sheets["Pivot Data"];
                let range = XLSX.utils.decode_range(ws["!ref"]);
    
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        let cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                        if (!ws[cell_address]) continue;
    
                        // Apply header styles (first row)
                        if (R === 0) {
                            ws[cell_address].s = {
                                font: { bold: true, sz: 14, color: { rgb: "FFFFFF" } },
                                fill: { fgColor: { rgb: "007BFF" } },
                                alignment: { horizontal: "center", vertical: "center" },
                                border: { top: { style: "thin" }, bottom: { style: "thin" } },
                            };
                        }
                        // Apply general styles to all cells
                        else {
                            ws[cell_address].s = {
                                font: { sz: 12, color: { rgb: "333333" } },
                                alignment: { horizontal: "center", vertical: "center" },
                                border: { top: { style: "thin" }, bottom: { style: "thin" } },
                            };
                        }
                    }
                }
    
                // Save the file
                XLSX.writeFile(wb, filename);
            }
        });
    });
     {% endcomment %}

     $(function () {
        // Function to load pivot data dynamically
        function loadPivotData(model) {
            let url = `leave-pivot?model=${model}`;
    
            // Fetch data dynamically based on model
            $.getJSON(url, function (data) {
                // Destroy and reinitialize pivot table with new data
                $("#pivot-container").empty();
    
                // Add Plotly renderers correctly
                let plotlyRenderers = $.pivotUtilities.plotly_renderers;
    
                // Initialize pivot table with Plotly enabled
                $("#pivot-container").pivotUI(data, {
                    rows: ["Name","Phone","Department","Shift", "Leave Type","Requested Days","Status"],
                    cols: [],
                    aggregatorName: "Count",
                    rendererName: "Table", // Default view as Table
                    onRefresh: function (config) {
                        let currentRenderer = config.rendererName;
                        if (
                            currentRenderer === "Table" ||
                            currentRenderer === "Table Barchart" ||
                            currentRenderer === "Heatmap" ||
                            currentRenderer === "Row Heatmap" ||
                            currentRenderer === "Col Heatmap"
                        ) {
                            $("#export-btn").show(); // Show button for tables
                        } else {
                            $("#export-btn").hide(); // Hide button for charts
                        }
                    },
                    renderers: $.extend($.pivotUtilities.renderers, plotlyRenderers), // Add Plotly renderers
                });
            });
        }
    
        // Initial load with all models
        loadPivotData("leave_request");
    
        // Model selection change event
        $("#model-select").on("change", function () {
            let selectedModel = $(this).val();
            loadPivotData(selectedModel); // Reload pivot data with selected model
        });
    
        // Export to Excel on button click
        $("#export-btn").on("click", function () {
            exportTableToExcel("pivot-container", "pivot_report.xlsx");
        });
    
        // Function to export table to Excel with custom styles
        function exportTableToExcel(containerId, filename) {
            let table = document.querySelector(`#${containerId} .pvtTable`);
            let wb = XLSX.utils.table_to_book(table, { sheet: "Pivot Data" });
            let ws = wb.Sheets["Pivot Data"];
    
            // Apply header styles
            applyHeaderStyles(ws);
    
            // Save the file
            XLSX.writeFile(wb, filename);
        }
    
        // Function to apply styles to Excel headers
        function applyHeaderStyles(ws) {
            let range = XLSX.utils.decode_range(ws["!ref"]);
    
            for (let C = range.s.c; C <= range.e.c; ++C) {
                let cell_address = XLSX.utils.encode_cell({ r: 0, c: C });
                if (!ws[cell_address]) continue;
    
                // Apply header styles (first row)
                ws[cell_address].s = {
                    font: { bold: true, sz: 14, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "007BFF" } },
                    alignment: { horizontal: "center", vertical: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: "000000" } },
                        bottom: { style: "thin", color: { rgb: "000000" } },
                    },
                };
            }
    
            // Apply cell styles for data
            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    let cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[cell_address]) continue;
    
                    ws[cell_address].s = {
                        font: { sz: 12, color: { rgb: "333333" } },
                        alignment: { horizontal: "center", vertical: "center" },
                        border: {
                            top: { style: "thin", color: { rgb: "DDDDDD" } },
                            bottom: { style: "thin", color: { rgb: "DDDDDD" } },
                        },
                    };
                }
            }
        }
    });
        
</script>


{% endblock content %}
